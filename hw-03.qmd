---
title: "HW 03"
author: "Cat Xia"
format:
  html:
    embed-resources: true
toc: true
---

## 1 - Du Bois challenge.

```{r loading packages}
#| label: loading packages

if (!require("pacman"))
  install.packages("pacman")

pacman::p_load(tidyverse, here, glue, scales, janitor, forcats, ggrepel)

ggplot2::theme_set(ggplot2::theme_minimal())
options(width = 65)
knitr::opts_chunk$set(
  fig.width = 7,
  fig.asp = 0.618,
  fig.retina = 3,
  fig.align = "center",
  api = 300
)

```

```{r load data}
#| label: load data

income <- read.csv(here("data", "income.csv"))
income <- clean_names(income)
glimpse(income)
```
```{r du bois data wrangling}
#| label: du bois data wrangling

#pivots the table so that it creates two new columns, one for spending type and one for the amount
income_clean <- income|>
  pivot_longer(cols = -c(class, average_income), names_to = "spending_type", values_to = "amount")

income_clean$class <- fct_relevel(
  income_clean$class,
  "$1000 AND OVER", 
  "$750-1000", 
  "$500-750", 
  "$400-500", 
  "$300-400", 
  "$200-300", 
  "$100-200"
)

income_clean$spending_type <- fct_relevel(
  income_clean$spending_type,
  "other", "tax", "clothes", "food", "rent"
)
```


```{r du bois recreation}
#| label: du bois recreation

income_clean |>
  ggplot(aes(x = class, y = amount, fill = spending_type, order = spending_type)) +
  geom_bar(stat = "identity", position = "fill") +
  coord_flip() +
  scale_fill_manual(values = c("grey","lightblue","pink", "#966FD6", "grey10")) 

```


## 2 - COVID survey - interpret

This graph is showing the the answers for each of the 6 questions regarding vaccines ("Vaccines are safe", "Vaccines make me feel safer at work", "Concern over Vaccine Side Effects", "Vaccine vetting process confidence", "vaccine information is trustworthy", and "I recommend the vaccine") for different identities from Age, Gender, Race, Ethnicity, Profession, or any prior vaccine experience for Covid and/or the flu. Starting from the top, for All data, most people tend to strongly agree on all questions regarding the vaccine except for "side effects" which is neutral. For age, there seems to be a trend where older people (>30) are more likely to believe in the vaccine and are closer to 1. Surprisingly, there was not a huge difference in gender across the 4 different options, with the exception of Non-binary, where the vaccine was more likely to be believed as less safe but also more likely to not be as concerned about the side effects as male or female respondents. As race goes, Native Hawaiian/Pacific Islander and White respondents are more likely to have doubts about the vaccine. Both Hispanic and non-hispanic respondents were fairly equal. Surprisingly, nursing and medical professions had concerns over the side effects of the vaccine at a higher level than a good portion of the other population. Additionally, those who had had the vaccine were more wary of side effects, but those who haven't were much more generally doubtful, for both the COVID and Flu vaccine.

From my initial response, I agree with the graph in that those who haven't had vaccines this year are more likely to express higher levels of doubt around the covid vaccine for Flu and Covid. My intuition disagrees with the Nursing and Medical professions having significant doubts about the side effects, but more specifically how there are no other professions to compare to. I could be interpreting this response incorrect, and it may be something like "the profession that gives you the vaccine", although I am unsure. Lastly, I also thought that younger people from <20 to 25 were more accepting of the vaccine and my intuition also disagrees with them having seemingly some of the greater concerns regarding the safety and side effects.

## 3 - COVID survey - reconstruct

```{r Q3 load data}
#| label: load data

covid <- read.csv(here("data", "covid-survey.csv"), skip = 1)
dim(covid)
```
```{r Q3 Data cleaning}
#| label: Q3 Data Cleaning

covid <- clean_names(covid)
covid <- covid |>
  filter(if_any(-1, ~ !is.na(.))) #*
dim(covid)
```
* Code after consulting with https://www.tidyverse.org/blog/2021/02/dplyr-1-0-4-if-any/. -1 from my own code, '~ !is.na(.)' formatting consulted from AI after multiple bug issues.

```{r Q3 renaming variables}
#| label: renaming variables

covid_survey <- covid |>
  mutate(
    "exp_already_vax" = if_else(exp_already_vax == 0, "No", "Yes"),
    
    "exp_flu_vax" = if_else(exp_flu_vax == 0, "No", "Yes"),
    
    "exp_profession" = if_else(exp_profession == 0, "Medical", "Nursing"),
    
    "exp_gender" = case_when(
      exp_gender == 0 ~ "Male",
      exp_gender == 1 ~ "Female",
      exp_gender == 3 ~ "Non-binary third gender",
      exp_gender == 4 ~ "Prefer not to say",
    ),
    
    "exp_race" = case_when(
      exp_race == 1 ~ "American Indian/Alaskan Native",
      exp_race == 2 ~ "Asian",
      exp_race == 3 ~ "Black/African American",
      exp_race == 4 ~ "Native Hawaiian/Other Pacific Islander",
      exp_race == 5 ~ "White"
    ),
    
    "exp_ethnicity" = if_else(exp_ethnicity == 1, "Hispanic/Latino", "Non-Hispanic/Non-Latino"),
    
    "exp_age_bin" = factor(case_when(
      exp_age_bin == 0 ~ "<20",
      exp_age_bin == 20 ~ "21-25",
      exp_age_bin == 25 ~ "26-30",
      exp_age_bin == 30 ~ ">30"),
      
      levels = c("<20", "21-25", "26-30", ">30")), #*
    
    "response_id" = as.double(response_id)
  )

dim(covid_survey)
```
* http://www.cookbook-r.com/Manipulating_data/Changing_the_order_of_levels_of_a_factor/

```{r pivot longer Q3 code given}
#| label: pivot longer Q3 code given

covid_survey_longer <- covid_survey |>
  pivot_longer(
    cols = starts_with("exp_"),
    names_to = "explanatory",
    values_to = "explanatory_value"
  ) |>
  filter(!is.na(explanatory_value)) |>
  pivot_longer(
    cols = starts_with("resp_"),
    names_to = "response",
    values_to = "response_value"
  )
glimpse(covid_survey_longer)
```
The first pivot longer is taking all the explanatory values (ie background info) and puting it in explanatory_value while the second pivot longer is taking all the reponses and puting them under response_value.

```{r Q3 grouping}
#| label: Q3 grouping

covid_survey_summary_stats_by_group <- covid_survey_longer |>
  group_by(explanatory, explanatory_value, response) |>
  summarise(mean = mean(response_value, na.rm = TRUE),
            low = quantile(response_value, probs = 0.1, na.rm = TRUE), #*
            high = quantile(response_value, probs = 0.9, na.rm = TRUE))

covid_survey_summary_stats_by_group <- covid_survey_summary_stats_by_group[order(covid_survey_summary_stats_by_group$explanatory_value),] #**

covid_survey_summary_stats_by_group
```
*https://www.tidyverse.org/blog/2020/03/dplyr-1-0-0-summarise/
**https://bookdown.org/ndphillips/YaRrr/order-sorting-data.html 

```{r Q3 summary not grouped}
#| label: summary not grouped Q3

covid_survey_summary_stats_all <- covid_survey_longer |>
  group_by(response, .drop = FALSE) |>
  summarise(mean = mean(response_value, na.rm = TRUE),
            low = quantile(response_value, probs = 0.1, na.rm = TRUE), 
            high = quantile(response_value, probs = 0.9, na.rm = TRUE),
            explanatory = "ALL",
            explanatory_value = factor(""),
            .groups = "drop"
            ) 

covid_survey_summary_stats_all
```

```{r Q3 binding together two df}
#| label: binding together summary stats all and by group

covid_survey_summary_stats <- rbind(covid_survey_summary_stats_all, covid_survey_summary_stats_by_group) #*

covid_survey_summary_stats
```

*https://www.datacamp.com/doc/r/merging 
```{r specifing the order of explanatory for easier faceting + facet titles}
#| label: specifying order of explanatory row for easier faceting + facet titles

covid_survey_summary_stats$explanatory <- factor(covid_survey_summary_stats$explanatory,
      levels = c("ALL", "exp_age_bin", "exp_gender", "exp_race", "exp_ethnicity", "exp_profession", "exp_already_vax", "exp_flu_vax"))

questions <- c("resp_safety" = "Based on my understanding, I believe the vaccine is safe",
               "resp_feel_safe_at_work" = "Getting the vaccine will make me feel safer at work", 
               "resp_concern_safety" = "I am concerned about the safety and side effects of the vaccine",
               "resp_confidence_science" = "I am confident in the scientific vetting process for the new COVID vaccines",
               "resp_trust_info" = "I trust the information that I have recieved about the vaccine", 
               "resp_will_recommend" = "I will recommend the vaccine to family, friends, and community members")

id_info <- c("ALL" = "All", 
             "exp_age_bin" = "Age", 
             "exp_gender" = "Gender", 
             "exp_race" = "Race", 
             "exp_ethnicity" = "Ethnicity", 
             "exp_profession" = "Profession",
             "exp_already_vax" = "Had COVID vaccine", 
             "exp_flu_vax" = "Had flu vaccine this year")
```


```{r Q3 recreating the graph}
#| label: recreating the graph for Q2

covid_survey_summary_stats |>
  ggplot(aes(x = mean, y = explanatory_value)) +
  geom_errorbar(aes(xmin = low, xmax = high), width = 0.5) + #from documentation
  geom_point(size = 1) +
  facet_grid(cols = vars(response), 
             rows = vars(explanatory), 
             scales = "free_y", 
             space = "free_y",
             labeller = labeller(explanatory = as_labeller(id_info, default = label_wrap_gen(width = 10)),
                                 response = as_labeller(questions, default = label_wrap_gen(width = 14))
                                 )) +
  labs(
    x = "Mean Likert score \n (Error bars range from 10th to 90th percentile)",
    y = NULL
  ) +
  scale_y_discrete(expand = c(0.1, 0.3)) + #*
  theme_bw() +
  theme(
    strip.text.x = element_text(size = 8, lineheight = 0.8),
    strip.text.y = element_text(size = 8, lineheight = 0.8, angle = 0),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_text(size = 8),
    axis.text.y = element_text(size = 8),
    axis.text.x = element_text(size = 8)
  )
```
* https://stackoverflow.com/questions/15400486/change-distance-between-x-axis-ticks-in-ggplot2 

## 4 - COVID survey - re-reconstruct

```{r Q4 recreate summary stats}
#| label: Q4 recreate summary stats

covid_survey_summary_stats_by_group2 <- covid_survey_longer |>
  group_by(explanatory, explanatory_value, response) |>
  summarise(mean = mean(response_value, na.rm = TRUE),
            low = quantile(response_value, probs = 0.25, na.rm = TRUE), 
            high = quantile(response_value, probs = 0.75, na.rm = TRUE))

covid_survey_summary_stats_by_grou2 <- covid_survey_summary_stats_by_group2[order(covid_survey_summary_stats_by_group2$explanatory_value),]

covid_survey_summary_stats_all2 <- covid_survey_longer |>
  group_by(response, .drop = FALSE) |>
  summarise(mean = mean(response_value, na.rm = TRUE),
            low = quantile(response_value, probs = 0.25, na.rm = TRUE), 
            high = quantile(response_value, probs = 0.75, na.rm = TRUE),
            explanatory = "ALL",
            explanatory_value = factor(""),
            .groups = "drop"
            ) 

covid_survey_summary_stats2 <- rbind(covid_survey_summary_stats_all2, covid_survey_summary_stats_by_group2)

covid_survey_summary_stats2$explanatory <- factor(covid_survey_summary_stats2$explanatory,
      levels = c("ALL", "exp_age_bin", "exp_gender", "exp_race", "exp_ethnicity", "exp_profession", "exp_already_vax", "exp_flu_vax"))

```


```{r Q4 graph with 25q and 75q}
#| label: Q4 graph with 25 quantile and 75 quantile

covid_survey_summary_stats2 |>
  ggplot(aes(x = mean, y = explanatory_value)) +
  geom_errorbar(aes(xmin = low, xmax = high), width = 0.5) + #from documentation
  geom_point(size = 1) +
  facet_grid(cols = vars(response), 
             rows = vars(explanatory), 
             scales = "free_y", 
             space = "free_y",
             labeller = labeller(explanatory = as_labeller(id_info, default = label_wrap_gen(width = 10)),
                                 response = as_labeller(questions, default = label_wrap_gen(width = 14))
                                 )) +
  labs(
    x = "Mean Likert score \n (Error bars range from 10th to 90th percentile)",
    y = NULL
  ) +
  scale_y_discrete(expand = c(0.1, 0.3)) + #*
  theme_bw() +
  theme(
    strip.text.x = element_text(size = 8, lineheight = 0.8),
    strip.text.y = element_text(size = 8, lineheight = 0.8, angle = 0),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_text(size = 8),
    axis.text.y = element_text(size = 8),
    axis.text.x = element_text(size = 8)
  )
```

## 5 - COVID survey - another view


